# ADR-006: TDD como Metodologia de Desenvolvimento

**Status**: Aceito
**Data**: 2025-12-03
**Decisores**: Stakeholder

## Contexto

O ForgeLLMClient sera desenvolvido seguindo o ForgeProcess, que define BDD para especificacao e TDD para implementacao.

O stakeholder definiu como **MANDATORIO** que testes sejam escritos ANTES do codigo fonte.

## Decisao

Adotar **TDD (Test-Driven Development)** como metodologia de desenvolvimento.

### Regra Fundamental

**TESTES SEMPRE ESCRITOS ANTES DO CODIGO FONTE**

### Ciclo TDD

```mermaid
flowchart TB
    RED["1. RED<br/>Escrever teste que falha<br/>- Teste descreve comportamento esperado<br/>- Codigo ainda nao existe<br/>- Teste DEVE falhar"]
    GREEN["2. GREEN<br/>Implementar minimo para passar<br/>- Escrever APENAS codigo necessario<br/>- Nao otimizar ainda<br/>- Teste DEVE passar"]
    REFACTOR["3. REFACTOR<br/>Melhorar sem quebrar<br/>- Limpar codigo<br/>- Remover duplicacoes<br/>- Testes DEVEM continuar passando"]

    RED --> GREEN --> REFACTOR --> RED

    style RED fill:#ffcdd2
    style GREEN fill:#c8e6c9
    style REFACTOR fill:#bbdefb
```

### Integracao com BDD

```mermaid
flowchart LR
    subgraph BDD["BDD (specs/bdd/*.feature)"]
        Gherkin["Cenarios Gherkin<br/>'O que o sistema faz'"]
    end

    subgraph TDD["TDD (tests/)"]
        Steps["Step Definitions<br/>'Como testar'"]
    end

    subgraph SRC["Codigo Fonte (src/)"]
        Impl["Implementacao"]
    end

    Gherkin --> Steps --> Impl

    style BDD fill:#e8f5e9
    style TDD fill:#fff3e0
    style SRC fill:#e3f2fd
```

### Fluxo de Trabalho

```mermaid
flowchart LR
    A["1. Pegar feature BDD<br/>com @skip"] --> B["2. Remover @skip<br/>do cenario"]
    B --> C["3. Rodar teste<br/>deve falhar (RED)"]
    C --> D["4. Implementar codigo<br/>minimo (GREEN)"]
    D --> E["5. Refatorar<br/>se necessario"]
    E --> F["6. Repetir<br/>proximo cenario"]
    F --> A
```

### Estrutura de Testes

```mermaid
flowchart TB
    subgraph tests["tests/"]
        subgraph unit["unit/"]
            domain_tests["domain/<br/>Testes de entidades, VOs"]
            app_tests["application/<br/>Testes de usecases"]
            prov_tests["providers/<br/>Testes com mock"]
        end
        subgraph integration["integration/"]
            int_prov["providers/<br/>Testes com APIs reais"]
        end
        subgraph bdd["bdd/"]
            conftest["conftest.py"]
            chat_steps["test_chat_steps.py"]
            tools_steps["test_tools_steps.py"]
        end
    end

    style unit fill:#e8f5e9
    style integration fill:#fff3e0
    style bdd fill:#e3f2fd
```

### Markers pytest

```python
# pytest.ini ja configurado com:
# @ci_fast - Testes rapidos (mocks)
# @ci_int  - Testes de integracao (APIs reais)

# Rodar apenas testes rapidos
pytest -m "ci_fast"

# Rodar testes de integracao
pytest -m "ci_int"
```

## Alternativas Consideradas

### 1. Desenvolvimento tradicional (codigo primeiro)
- **Pros**: Mais rapido inicialmente
- **Contras**: Menos cobertura, mais bugs, dificil refatorar

### 2. Testes depois do codigo
- **Pros**: Ver codigo funcionando antes
- **Contras**: Testes tendem a ser esquecidos, vieses de confirmacao

### 3. TDD (ESCOLHIDA - MANDATORIO)
- **Pros**: Codigo testavel por design, documentacao viva, refatoracao segura
- **Contras**: Curva de aprendizado, pode parecer mais lento inicialmente

## Consequencias

### Positivas
- Codigo testavel desde o inicio
- Documentacao viva via testes
- Refatoracao segura (testes como rede de seguranca)
- Bugs detectados cedo
- Design emergente e limpo

### Negativas
- Requer disciplina
- Pode parecer mais lento inicialmente
- Precisa saber escrever bons testes

## Metas de Cobertura

| Camada | Meta |
|--------|------|
| Domain | >= 95% |
| Application | >= 90% |
| Infrastructure | >= 80% |
| Adapters | >= 70% |
| **Total** | **>= 80%** |

## Validacao

- [ ] Nenhum codigo fonte sem teste correspondente
- [ ] Cobertura >= 80%
- [ ] CI falha se cobertura cair
- [ ] Todos os cenarios BDD tem step definitions

## Referencias

- `docs/guides/forgebase_guides/usuarios/guia-de-testes.md`
- `process/execution/tdd/TDD_PROCESS.md`
- Kent Beck - Test-Driven Development by Example
